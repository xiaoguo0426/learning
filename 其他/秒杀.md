## 高并发访问

### 接口限流

接口限流本身也是系统安全防护的一种措施

- 令牌桶限流
- 单用户访问频率限流
- 抢购接口隐藏

#### 接口限流

在面临高并发的请购请求时，我们如果不对接口进行限流，可能会对后台系统造成极大的压力。尤其是对于下单的接口，过多的请求到达数据库会对系统的稳定性造成影响。

所以秒杀系统会进行选择独立于公司其他系统之外进行单独部署，以免秒杀业务崩溃影响到其他系统。

除了独立部署秒杀业务之外，我们能够做的就是尽量让后台系统稳定优雅地处理大量请求。

###### 令牌桶限流法

> 令牌桶算法（Token Bucket Algorithm）是一种用于流量控制的算法，主要用于限制数据发送的速率，或者对网络流量进行整形。它在计算机网络、操作系统等领域有广泛应用，比如网络带宽管理、流量调度等。

###### 基本原理
令牌桶算法的核心思想是通过一个“桶”来存储“令牌”，令牌以固定的速率生成并放入桶中，而数据发送或处理需要消耗桶中的令牌。如果桶中的令牌不足，数据发送会被延迟或丢弃。

具体步骤如下：
- 令牌生成：令牌以固定的速率（如每秒生成一定数量的令牌）放入桶中。
桶的容量限制：桶有一个最大容量，当桶中的令牌达到容量上限时，多余的令牌会被丢弃。
- 数据发送：当需要发送数据时，会从桶中取出一定数量的令牌。如果桶中没有足够的令牌，数据发送会被延迟或拒绝。

工作示例
```code
假设：

桶的容量为 100 个令牌。

令牌生成速率为每秒 10 个令牌。

每发送 1 个数据包需要消耗 1 个令牌。

如果桶是空的，令牌会以每秒 10 个的速度逐渐填满，直到达到桶的最大容量（100 个）。

当需要发送数据时，系统会从桶中取出令牌。如果桶中有足够的令牌，数据可以立即发送；如果桶中令牌不足，数据会被延迟，直到桶中有足够的令牌。

```

应用场景
```code
网络带宽管理：

限制网络流量的速率，避免网络拥塞。
例如，ISP（互联网服务提供商）可以使用令牌桶算法限制用户的带宽。
流量整形：
平滑突发流量，使流量更均匀地通过网络。
系统资源控制：
限制应用程序的资源使用速率，例如限制 API 请求的频率。

优点
1. 灵活性：
可以根据需求调整令牌生成速率和桶的容量。
突发流量支持：
桶中的令牌可以积累，允许在短时间内处理突发流量。

2. 简单易实现：
算法逻辑简单，容易在软件或硬件中实现。

缺点
1. 配置复杂：
需要合理设置令牌生成速率和桶的容量，否则可能影响性能。

2. 延迟问题：
如果桶中没有足够的令牌，数据发送会被延迟。
```

###### 漏桶算法

> 是一种用于流量控制的算法，主要用于限制数据发送的速率或平滑突发流量。它在计算机网络、操作系统等领域有广泛应用，比如网络带宽管理、流量整形等。

###### 基本原理
> 漏桶算法的核心思想是通过一个“桶”来限制数据的输出速率。数据以任意速率流入桶中，但桶底部有一个固定速率的“漏水孔”，数据只能以这个固定速率流出。如果桶中的数据量超过了桶的容量，多余的流量会被丢弃。

具体步骤如下：

数据流入：数据以任意速率流入桶中。

固定速率流出：数据以固定的速率从桶中流出。

桶容量限制：桶有一个最大容量，当桶中的数据量超过容量时，多余的流量会被丢弃。

工作示例
```code
假设：

桶的容量为 100 个单位。

桶的流出速率为每秒 10 个单位。

如果数据以每秒 15 个单位的速率流入桶中，桶会逐渐填满，直到达到容量上限（100 个单位）。
当桶满时，多余的流量会被丢弃。

桶中的数据以固定的速率（每秒 10 个单位）流出。
```

应用场景
```code
网络带宽管理：
限制网络流量的速率，避免网络拥塞。
例如，ISP（互联网服务提供商）可以使用漏桶算法限制用户的带宽。

流量整形：
平滑突发流量，使流量更均匀地通过网络。
系统资源控制：
限制应用程序的资源使用速率，例如限制 API 请求的频率。

优点

1. 简单易实现：
算法逻辑简单，容易在软件或硬件中实现。
2. 严格限制速率：
数据流出速率是固定的，可以严格控制流量。

缺点
1. 无法支持突发流量：
漏桶算法不允许突发流量，所有超出桶容量的数据都会被丢弃。
2. 延迟问题：
如果桶中的数据量较大，可能会导致数据发送的延迟。

```

![](assets/markdown-img-paste-20200703113402649.png)

![](assets/markdown-img-paste-20200703113413968.png)

![](assets/markdown-img-paste-20200703113808443.png)


### 分流
> 主要通过分布式集群技术，多台机器处理，提高并发能力。

### 动静分离

> 将动态数据和静态数据尽量分离，并通过缓存和CDN技术对数据读取进行加速

## 数据正确性

秒杀伴随着一系列业务流程，包括浏览商品，进入抢购页面，购买，扣除库存，支付。其中并发主要是与扣库存有关，要保证数据的正确性，防止超卖发生。大概的解决方法有：

1. 减库存：事务判断，热点商品放到单独的热点库，增加并发锁。
2. 热点：对核心热点数据进行实时分析，并在系统中进行优化或隔离。
3. 限流降级：请求限流，控制系统的访问；对服务的下流依赖进行降级，保证核心链路不被影响。
4. 异步化：是指把购买请求的接受和处理异步化。购买请求先放到队列中，这个请求非常高效，返回客户信息。

## 防作弊

抢购还需要保证公平性，防止黄牛党和自动抢票软件。从技术角度，大概方法有：
答题：为了增加购买的复杂度；延缓请求。
Cache校验：处理用户购买请求时校验缓存中是否已记录此商品的购买。

## 秒杀系统设计原则

1. 请求请求数尽量少
> 前台请求会增加浏览器的负担，尽量简化或合并页面大小（css/js，图片等）；减少DNS解析
2. 后台请求数尽量少
> 后台数据会增加网络传输，压缩和字符编码，消耗CPU。需要梳理后台依赖的数据和服务，关注序列化/反序列化方式，减少不必要的数据交互。
3. 调用路径要尽量少
4. 尽量不要有单点
> 高可用和稳定性角度，消除单点；服务无状态化，解耦服务状态和机器，如机器配置动态化；有状态的存储，通过冗余备份提高可用性。

### 高并发之“访问拦截”

高并发的访问拦截主要思路是：

> 从浏览器/反向代理/Web层/服务层 多层拦截流量，尽量把访问拦截在离用户最近的层，尽可能地过滤无效请求，让“漏斗”最末端的才是最有效的请求。同时，用户请求最早的得到处理，也减少了每次请求的RT，进而提高了系统的QPS和并发程度

![](assets/markdown-img-paste-20200708094738178.png)

浏览器访问拦截

> 防止用户的不必要的点击，可以在产品层面限制用户的行为，比如点击后按钮不可用；限定时间内接受请求；防作弊；答题/Cache校验等

CDN加速

> CDN全称Content Delivery NetWork，即内容分发网络。简单来说，就是把原服务器上的数据复制到其他服务器上，用户就近访问服务器获取资源。缺点是内容变更生效慢。

反向代理访问拦截

> 主要是动静分离，静态文件作为web项目的一部分进行发布；另外通过Nginx托管静态文件，减轻Web服务器的压力。【前后端分离？】

Web层和Service层访问拦截

> 主要是动态数据访问，可以采用缓存的策略，减少对下一层的数据访问。缓存又可以分为本地缓存和redis，memcache等缓存中间件。

高并发之“分流”

> 分流主要通过分布式集群技术，多台机器处理，提高并发能力。

![](assets/markdown-img-paste-20200708100346448.png)

Nginx负载均衡

> Nginx可以支持10w的并发访问，Nginx支持配置请求的代理策略，把请求路由到多个web服务器处理。Nginx支持的负载均衡策略包括：轮询，权重，ip_hash，fair，url_hash等

Redis集群：

> redis单台几十万的QPS，可通过Redis集群，把数据分配到多台服务器上，减轻每台机器的负载

MySQL读写分离：

> 对于读请求，一般采用读写分离的策略。读库应用单独设置索引，提高读性能。


1.秒杀活动中，商品库存放在redis中不可取，但是可以完成一些前置限流工作，后续实际库存扣减工作还是要MySQL落地为准。Redis可以作为库存计数器，当db实例扣减完了回写redis，让后续请求不在发送。

2.为防超卖，后续需要对账机制。核对每条订单的购买数目与总数，把超卖订单退还。

3.如果使用redis集群模式，主备同步有一定的延迟。

4.可以对商品库存进行分片，redis锁可以落地当不同的分片上。
