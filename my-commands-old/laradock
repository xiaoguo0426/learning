#!/bin/bash

# å¼•å…¥å…¬å…±éƒ¨åˆ†
source /home/xiaoguo0426/my-commands/common.sh

laradock_path="$HOME/gits/laradock"
docker_compose="docker compose"

# è·å–æœ€åä¸€ä¸ªå‚æ•°
last_arg="${@: -1}"
if [[ $last_arg =~ ^--(74|81)$ ]]; then          # â† å°±æ˜¯ç¼ºäº†è¿™å¥
    version="${last_arg#--}"
    laradock_path="$HOME/gits/laradock$version"

    # åˆ¤æ–­ç›®å½•æ˜¯å¦å­˜åœ¨
    if [[ ! -d $laradock_path ]]; then
        log_error "âŒ ç›®å½•ä¸å­˜åœ¨: $laradock_path"
        exit 1
    fi

    # ä»å‚æ•°åˆ—è¡¨é‡Œå‰”é™¤ç‰ˆæœ¬é€‰é¡¹
    set -- "${@:1:$(($#-1))}"
fi

log_info "âœ¨ å½“å‰ç›®å½•æ˜¯ $laradock_path"


# https://emojipedia.org/

# æ£€æŸ¥å‚æ•°æ•°é‡
if [ "$#" -lt 1 ]; then
  log_error "âŒ laradock ç¼ºå°‘å‚æ•°"
  exit 1
fi

# åˆ‡æ¢åˆ° laradock ç›®å½•
cd "$laradock_path" || {
  log_error "âŒ æ— æ³•åˆ‡æ¢åˆ° Laradock ç›®å½•: $laradock_path"
  exit 1
}

# å¤„ç†ä¸åŒå‘½ä»¤
case "$1" in
  "ps")
    $docker_compose ps 
    ;;
  "up")
    # up å‘½ä»¤å¿…é¡»ä¼ ç¬¬äºŒä¸ªå‚æ•°ï¼Œå¹¶æ·»åŠ  -d é€‰é¡¹
    if [ "$#" -lt 2 ]; then
      log_error "ğŸš¨ å‘½ä»¤ '$1' éœ€è¦ç¬¬äºŒä¸ªå‚æ•°"
      exit 1
    else
      log_info "ğŸš€ æ‰§è¡Œ Laradock '$1' å‘½ä»¤ï¼Œå‚æ•°: $2"
      $docker_compose "$1" -d "$2"
    fi
    ;;
  "logs"|"build"|"start"|"restart")
    # è¿™äº›å‘½ä»¤å¿…é¡»ä¼ ç¬¬äºŒä¸ªå‚æ•°
    if [ "$#" -lt 2 ]; then
      log_error "ğŸš¨ å‘½ä»¤ '$1' éœ€è¦ç¬¬äºŒä¸ªå‚æ•°"
      exit 1
    else
      log_info "ğŸš€ æ‰§è¡Œ Laradock $1 $2"
      $docker_compose "$1" "$2"
    fi
    ;;
  "stop")
    # stop å‘½ä»¤å¯ä»¥ä¸ä¼ ç¬¬äºŒä¸ªå‚æ•°
    if [ "$#" -eq 1 ]; then
      log_info "â³ åœæ­¢æ‰€æœ‰ Laradock å®¹å™¨"
      $docker_compose stop
    else
      log_info "â³ åœæ­¢ Laradock æœåŠ¡: $2"
      $docker_compose stop "$2"
    fi
    ;;
  "exec")
    log_info "ğŸš€Laradock $2 container..."
    if [ "$2" = "workspace" ]; then
      $docker_compose exec --user=laradock "$2" bash
    else
      $docker_compose exec "$2" bash
    fi
    ;;
  *)
    log_error "âŒ æœªçŸ¥å‘½ä»¤: $1"
    exit 1
    ;;
esac