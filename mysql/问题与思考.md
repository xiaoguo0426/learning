##### 1. MySQL 是否有需要使用外键

- 外键可以保证数据的完整性和一致性，但是同时也会带来一些问题
- MySQL需要额外的开销来检测数据的完整性和一致性，容易造成死锁，MySQL处理性能势必会下降
- 增加额外的索引消耗


##### 2. CAS乐观锁


> 乐观锁假设认为数据一般情况下不会造成冲突，所以在数据进行提交更新的时候，才会正式对数据的冲突与否进行检测，如果发生了冲突，则返回错误信息，让用户决定如何去做。


```mysql

select sales from tbl_product where product_id = 1;//sales = 5;

//TODO

update tbl_product set sales = 5 + 1 where product_id = 1 and sales = 5;

```

在极限情况下仍然有几率会出现ABA问题。

##### 3. ABA问题

> 线程1与线程2同时读取到一个变量V，线程1需要把变量V的值修改成A，线程2需要把变量V修改成B后，发生了意外，把B变回了A，此时线程1发现V的值还是A，所以继续执行，但是此A非彼A。这就是ABA问题。


解决方案：引入版本号（时间戳）对比

乐观锁每次在执行数据的修改操作时，都会带上一个版本号，一旦版本号和数据的版本号一致就可以执行修改操作并对版本号执行+1操作，否则就执行失败

优化后：

```mysql

select sales,version from tbl_product where product_id = 1;//sales = 5;version=10086

//TODO

update tbl_product set sales = 5 + 1,version = 10086 + 1  where product_id = 1 and version = 10086;

```

##### 4. 幂等性

> 相同条件下，执行同一请求，得到的结果相同，才符合幂等性。
