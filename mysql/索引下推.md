索引下推（Index Condition Pushdown，简称 **ICP**）是 MySQL 中针对索引查询的一种优化技术，**主要目的是减少回表次数，提升查询性能**。它在存储引擎层提前对索引数据进行过滤，避免将不符合条件的记录传递到服务器层再过滤。

---

### **1. 什么是索引下推？**
- **核心思想**  
  将原本在 **MySQL 服务器层** 进行的过滤操作，下推到 **存储引擎层**（如 InnoDB）完成。  
  存储引擎可以直接利用索引中的字段信息，提前过滤不符合条件的记录，减少回表查询的次数。

- **解决的问题**  
  在复合索引（多列索引）中，如果查询条件包含索引列但无法全部被索引覆盖时，传统方式需要回表后才能过滤非索引列的条件，而 ICP 允许在回表前先过滤部分条件。

---

### **2. 工作原理对比（有无 ICP）**
#### **无 ICP 的传统流程**  
假设有一个复合索引 `(a, b)`，执行查询：  
```sql
SELECT * FROM table WHERE a = 1 AND b > 10 AND c = 'xxx';
```
1. **存储引擎层**  
   - 使用索引 `(a, b)` 找到所有 `a = 1` 的记录。  
   - 将满足 `a = 1` 的主键全部返回给服务器层。  
2. **服务器层**  
   - 根据主键回表查询完整数据行。  
   - 再过滤 `b > 10` 和 `c = 'xxx'` 的条件。  

**问题**：即使 `b > 10` 是索引列的条件，服务器层仍需回表后才能过滤，导致回表次数过多。

---

#### **有 ICP 的流程**  
1. **存储引擎层**  
   - 使用索引 `(a, b)` 找到所有 `a = 1` 的记录。  
   - **直接利用索引中的 `b` 列过滤 `b > 10` 的条件**，仅保留符合条件的记录。  
   - 将剩余记录的主键返回给服务器层。  
2. **服务器层**  
   - 根据主键回表查询完整数据行。  
   - 最后过滤 `c = 'xxx'` 的条件。  

**优势**：在存储引擎层提前过滤了 `b > 10`，减少了回表次数。

---

### **3. ICP 的触发条件**
- **必须使用二级索引**（非主键索引）。  
- 查询的 `WHERE` 条件中，至少有一个条件能通过索引过滤。  
- 适用于 `EXPLAIN` 输出中的 `type` 为 `range`、`ref`、`eq_ref`、`ref_or_null` 的查询。  
- 支持 InnoDB 和 MyISAM 存储引擎（需 MySQL 5.6 及以上版本）。

---

### **4. 如何确认 ICP 是否生效？**
通过 `EXPLAIN` 查看执行计划：  
- 如果 `Extra` 列显示 `Using index condition`，表示启用了 ICP。  
```sql
EXPLAIN SELECT * FROM table WHERE a = 1 AND b > 10 AND c = 'xxx';
```

---

### **5. 示例说明**
#### **表结构**
```sql
CREATE TABLE user (
    id INT PRIMARY KEY,
    age INT,
    name VARCHAR(20),
    KEY idx_age_name (age, name)
);
```

#### **查询语句**
```sql
SELECT * FROM user
WHERE age > 18 AND name LIKE '张%';
```

#### **无 ICP 时的流程**
1. 存储引擎通过索引 `idx_age_name` 找到所有 `age > 18` 的记录。  
2. 将所有满足 `age > 18` 的主键返回给服务器层。  
3. 服务器层回表查询完整数据，再过滤 `name LIKE '张%'`。

#### **有 ICP 时的流程**
1. 存储引擎通过索引 `idx_age_name` 找到所有 `age > 18` 的记录。  
2. **直接利用索引中的 `name` 列过滤 `name LIKE '张%'`**（即使 `name` 是索引的第二列）。  
3. 仅将符合条件的记录的主键返回给服务器层。  
4. 服务器层回表查询完整数据。

---

### **6. ICP 的限制**
- **不适用于主键索引**（聚簇索引），因为主键索引存储的是完整数据行，无需回表。  
- **不适用于覆盖索引**（查询字段全部在索引中），因为无需回表。  
- 如果查询条件中的字段不在索引中，ICP 无法生效。  
- 部分条件无法下推（如涉及子查询或函数计算的条件）。

---

### **7. 性能提升场景**
- **复合索引中的非前导列条件**  
  例如索引 `(a, b)`，查询条件包含 `b` 时，ICP 可以利用索引直接过滤。  
- **减少回表次数**  
  存储引擎提前过滤掉大量无效数据，减少磁盘 I/O 和服务器层处理开销。

---

### **总结**
| **特性**       | **说明**                                                                 |
|----------------|-------------------------------------------------------------------------|
| **核心目的**    | 减少回表次数，提升查询性能                                               |
| **实现方式**    | 将索引列的过滤条件下推到存储引擎层处理                                     |
| **适用场景**    | 复合索引、范围查询、部分 `WHERE` 条件可通过索引过滤                        |
| **查看方式**    | `EXPLAIN` 中 `Extra` 列显示 `Using index condition`                     |
| **版本支持**    | MySQL 5.6+（需存储引擎支持，如 InnoDB）                                  |

通过索引下推，MySQL 显著优化了复合索引查询的效率，是高性能 SQL 的重要优化手段之一。
